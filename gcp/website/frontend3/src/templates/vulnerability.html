{% extends 'base.html' -%}
{% set active_section = 'vulnerabilities' -%}

{% block extra_head %}
<link rel="preload" fetchpriority="high" as="image" href="/static/img/external-link.svg" type="image/webp">
{% endblock %}

{% block content -%}
<turbo-stream action="update" target="title">
  <template>
    OSV - {{ vulnerability.id }}
  </template>
</turbo-stream>

{% include 'vulnerability_content.html' %}

<script>
  document.addEventListener('turbo:load', function() {
    const ECOSYSTEM_EXPAND_THRESHOLD = 10;
    const PACKAGE_EXPAND_THRESHOLD = 7;
    const ECOSYSTEM_PACKAGE_COLLAPSE_THRESHOLD = 9;

  /**
   * Sets up the vertical, grouped layout for vulnerability packages.
   * - All ecosystem headers are expanded if their total count is below `ECOSYSTEM_EXPAND_THRESHOLD`,
   *   and if their total packages count is below `ECOSYSTEM_PACKAGE_COLLAPSE_THRESHOLD`.
   * - Within each ecosystem, all package headers are expanded if their count is below `PACKAGE_EXPAND_THRESHOLD`.
   */
    function setupVerticalLayout() {
      const ecosystemAccordions = document.querySelectorAll('.vulnerability-packages.force-collapse .ecosystem-accordion');
      if (!ecosystemAccordions.length) return;

      const shouldExpandEcosystems = ecosystemAccordions.length < ECOSYSTEM_EXPAND_THRESHOLD;

      ecosystemAccordions.forEach(accordion => {
        const panel = accordion.querySelector('.ecosystem-content-panel');
        const packageAccordions = panel ? panel.querySelectorAll('.package-accordion') : [];
        const hasManyPackages =
          ecosystemAccordions.length > 1 && packageAccordions.length > ECOSYSTEM_PACKAGE_COLLAPSE_THRESHOLD;

        const shouldExpandAccordion =
          shouldExpandEcosystems &&
          panel !== null &&
          !hasManyPackages;

        accordion.open = shouldExpandAccordion;

        const shouldExpandPackages = packageAccordions.length <= PACKAGE_EXPAND_THRESHOLD;
        packageAccordions.forEach(packageAccordion => {
          packageAccordion.open = shouldExpandPackages;
        });
      });
    }
    
    if (document.querySelector('.vulnerability-packages.force-collapse')) {
      setupVerticalLayout();
    }

    /**
     * Sets up "Show More" / "Show Less" functionality for lists that might have
     * many items. You can enable this feature by adding an 'expandible-list' or
     * 'expandible-hierarchy-list' class to lists with long value.
     * @param {string} listSelector The CSS selector for the list container.
     * @param {string} itemSelector The tag name of the items within the list.
     */
    function setupExpandibleList(listSelector, itemSelector) {
      const EXPANDIBLE_LIST_DEFAULT_LENGTH = 6;
      const lists = document.querySelectorAll(`${listSelector}:not(.expanded):not([data-has-toggle-btn])`);
      lists.forEach((list) => {
        const items = list.getElementsByTagName(itemSelector);
        if (items.length <= EXPANDIBLE_LIST_DEFAULT_LENGTH) return;

        const expandibleItems = [...items].slice(EXPANDIBLE_LIST_DEFAULT_LENGTH);
        expandibleItems.forEach((item) => {
          item.style.display = 'none';
        });

        const toggleButton = document.createElement('span');
        toggleButton.classList.add('showmore');
        toggleButton.textContent = 'Show More';
        list.append(toggleButton);
        list.setAttribute('data-has-toggle-btn', 'true');

        toggleButton.addEventListener('click', function() {
          const isExpanded = list.classList.contains('expanded');
          expandibleItems.forEach((item) => {
            item.style.display = isExpanded ? 'none' : 'block';
          });
          toggleButton.textContent = isExpanded ? 'Show More' : 'Show Less';
          list.classList.toggle('expanded');
        });
      });
    }

    setupExpandibleList('.expandible-hierarchy-list', 'ul');
    setupExpandibleList('.expandible-list', 'li');
  });
</script>
{% endblock -%}
